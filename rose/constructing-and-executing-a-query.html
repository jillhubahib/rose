<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Constructing and Executing a Query :: rose</title>
    <link rel="canonical" href="https://laurence-myers.github.io/rose/rose/constructing-and-executing-a-query.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://laurence-myers.github.io/rose">rose</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/laurence-myers/rose/">Code @ GitHub</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rose" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">rose</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="quick-start.html">Quick Start</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="schema-introspection.html">Schema Introspection</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="constructing-and-executing-a-query.html">Constructing and Executing a Query</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="justification.html">Why Rose?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="alternate-projects.html">Alternate Projects</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">rose</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">rose</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">rose</a></li>
    <li><a href="constructing-and-executing-a-query.html">Constructing and Executing a Query</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Constructing and Executing a Query</h1>
<div class="paragraph">
<p>To select all columns from all rows in the <code>Customer</code> table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">const rows = await select(CustomerAllColumns) <i class="conum" data-value="1"></i><b>(1)</b>
    .finalise({}) <i class="conum" data-value="2"></i><b>(2)</b>
    .execute(client, {}); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We select all columns by passing <code>CustomerAllColumns</code>. This comes from code generated by <code>rose-cli</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A query is not executable until it is "finalised", which converts it to a SQL string. We pass an empty object,
representing the parameters that are accepted by the query. (This will be explained later.)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Finally, we execute the query, passing it some "queryable" object such as an instance of <code>pg.Client</code> from the <code>pg</code>
library. We pass an object containing the query parameters; in this query, we have none, so the object is empty.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The value in <code>rows</code> will be an array of objects, each containing a property for every column; <code>firstName</code> for the column
<code>first_name</code>, <code>createdDate</code> for the column <code>create_date</code>, etc.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s only get the first and last names of every customer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">await select({
    firstName: QCustomer.firstName,
    lastName: QCustomer.lastName
})
    .finalise({})
    .execute(client, {});</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time, we pass in an object with only two properties. The property names act as an "alias" of the underlying column.
The values are "column metamodels", generated from <code>rose-cli</code>. Think of it as a description of a column.</p>
</div>
<div class="paragraph">
<p>Notice that we never specify the table to query. This is because the column metamodel already knows which table it
belongs to. The query builder will try to infer any tables that are not explicitly listed in "from" or "join" clauses.</p>
</div>
<div class="paragraph">
<p>We could have also explicitly listed the "from" table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">await select({
    firstName: QCustomer.firstName,
    lastName: QCustomer.lastName
})
    .from(QCustomer)
    .finalise({})
    .execute(client, {});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated SQL will be the same.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s retrieve the first and last name of a single customer, by their customer ID.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">await withParams&lt;{ customerIdToFind: CustomerRow['customerId'] }&gt;()( <i class="conum" data-value="1"></i><b>(1)</b>
    (p) =&gt; <i class="conum" data-value="2"></i><b>(2)</b>
        select({
            firstName: QCustomer.firstName,
            lastName: QCustomer.lastName
        })
            .where(QCustomer.customerId.eq(p.customerIdToFind)) <i class="conum" data-value="3"></i><b>(3)</b>
            .finalise(p) <i class="conum" data-value="4"></i><b>(4)</b>
).execute(client, { customerIdToFind: 1234 }); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>withParams()</code> is a convenience function. We use it to specify what parameters the query will accept.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We pass a callback function, which accepts a <code>ParamsProxy</code> and returns a query builder.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We&#8217;ve added a <code>where()</code> clause, comparing the <code>customerId</code> to the query parameter <code>customerIdToFind</code>. (Note that
<code>customerIdToFind</code> does not yet have a value; we&#8217;re actually inserting a placholder that will be resolved when the
query is executed.)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>When finalising the query, we pass in the <code>ParamsProxy</code> object. This tells the query builder what query parameters
will be accepted.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Finally, when we execute the query, we must pass in an object with the property <code>customerIdToFind</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>withParams()</code> returns a function that should be invoked immediately! For example, <code>withParams()(callback)</code>. This is a hack to get TypeScript&#8217;s type
inference working nicely.</p>
</div>
<div class="paragraph">
<p>If you are a TypeScript guru and can think of a way to avoid this, please get in contact!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <code>ParamsProxy</code> is an object that pretends to have the same properties as the type given to <code>withParams()</code>, but uses
magic; every property will actually return a placeholder that can be used in query building.</p>
</div>
</td>
</tr>
</table>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the rose Antora UI theme.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
