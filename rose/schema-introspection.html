<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Schema Introspection :: rose</title>
    <link rel="canonical" href="https://laurence-myers.github.io/rose/rose/schema-introspection.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://laurence-myers.github.io/rose">rose</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="/api/">API Docs</a>
        <a class="navbar-item" href="https://github.com/laurence-myers/rose/">Code @ GitHub</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rose" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">rose</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="quick-start.html">Quick Start</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="how-it-works.html">How It Works</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="schema-introspection.html">Schema Introspection</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="constructing-and-executing-a-query.html">Constructing and Executing a Query</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="query-selectors.html">Query Selectors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="commands.html">Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="postgresql-functions.html">PostgreSQL Functions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="connection-manager.html">Connection Manager and Database Context</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="justification.html">Why Rose?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="alternate-projects.html">Alternate Projects</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">rose</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">rose</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">rose</a></li>
    <li><a href="schema-introspection.html">Schema Introspection</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Schema Introspection</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><code>rose</code> depends on code generated from your database schema. <code>rose-cli</code> introspects your database to generate the code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generated_code"><a class="anchor" href="#_generated_code"></a>Generated code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Given a table <code>customer</code>, the following code is generated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CustomerRow</code>, representing an object with all columns.</p>
</li>
<li>
<p><code>CustomerInsertRow</code>, as above, but marks properties as optional if they are:</p>
<div class="ulist">
<ul>
<li>
<p>nullable, or</p>
</li>
<li>
<p>have a default value.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>TCustomer</code>, the table "metamodel", implemented as a class extending <code>QueryTable</code>.</p>
</li>
<li>
<p><code>QCustomer</code>, a default instance of <code>TCustomer</code>.</p>
</li>
<li>
<p><code>QCustomerAllColumns</code>, an object that can be used to select all columns from the table.</p>
</li>
<li>
<p><code>CustomerDefaultQueries</code>, containing queries for simple Create/Read/Update/Delete (CRUD) operations.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>getOne()</code> and <code>deleteOne()</code> accept all the data they need when the query is executed. The queries are only generated
once.</p>
</div>
<div class="paragraph">
<p><code>insertOne()</code> and <code>updateOne()</code> will dynamically generate their queries each time they are called. This is to support
optional properties.</p>
</div>
<div class="paragraph">
<p>If you always know what columns are provided when inserting/updating rows, you will probably want to implement your own
insert/update queries.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the table had no primary key, then some queries would be omitted. Only <code>insertOne()</code> would be generated.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_via_rose_json"><a class="anchor" href="#_configuration_via_rose_json"></a>Configuration via <code>rose.json</code></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overriding_types"><a class="anchor" href="#_overriding_types"></a>Overriding types</h3>
<div class="paragraph">
<p><code>rose-cli</code> attempts to map PostgreSQL column types to TypeScript types, based on what the <code>pg</code> library returns.</p>
</div>
<div class="paragraph">
<p>You may wish to override these types, if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A text column uses check constraints to restrict the allowed values</p>
</li>
<li>
<p>The column uses a custom column type</p>
</li>
<li>
<p>You override `pg&#8217;s type parser for a column type (e.g. to allow 64-bit integer columns to return BigInt instead of
a string)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can override the types globally for all tables, or per table column.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>PostgreSQL enum types are automatically identified, and typed as a union of string literals.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_global_override"><a class="anchor" href="#_global_override"></a>Global override</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "types": {
        "global": {
            "int8": "BigInt"
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_column_override"><a class="anchor" href="#_column_override"></a>Column override</h4>
<div class="paragraph">
<p>To specify the new type in the JSON config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "types": {
        "columns": {
            "film.rating": "'G' | 'PG' | 'PG-13' | 'R' | 'NC-17' | null"
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To import the type from another file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "types": {
        "columns": {
            "film.rating": {
                "from": "../src/film/rating.ts",
                "type": "Rating"
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ignoring_tables"><a class="anchor" href="#_ignoring_tables"></a>Ignoring tables</h3>
<div class="paragraph">
<p>Add the property <code>ignore</code>, with an array of table names.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "ignore": [
        "audit_log",
        "statement_stats"
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following table names are always ignored:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>__MigrationHistory</code>, from Entity Framework</p>
</li>
<li>
<p><code>alembic_version</code>, from SQLAlchemy Alembic</p>
</li>
<li>
<p><code>DATABASECHANGELOG</code>, from Liquibase</p>
</li>
<li>
<p><code>django_migrations</code>, from Django</p>
</li>
<li>
<p><code>flyway_schema_history</code>, from Flyway</p>
</li>
<li>
<p><code>knex_migrations</code>, from Knex.js</p>
</li>
<li>
<p><code>migrations</code>, from db-migrations, TypeORM</p>
</li>
<li>
<p><code>mikro_orm_migrations</code>, from MikroORM</p>
</li>
<li>
<p><code>schema_migrations</code>, from ActiveRecord (Ruby on Rails)</p>
</li>
<li>
<p><code>SequelizeMeta</code>, from umzug (Sequelize)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integrating_rose_cli_into_your_build_process"><a class="anchor" href="#_integrating_rose_cli_into_your_build_process"></a>Integrating <code>rose-cli</code> into your build process</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You&#8217;ll need to decide how to incorporate <code>rose-cli</code> into your application&#8217;s build process. The exact implementation
depends on your application&#8217;s structure, when database migrations are applied, and continuous integration setup.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s one approach to consider:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Apply any database migrations to your local database.</p>
</li>
<li>
<p>Run <code>rose-cli</code>.</p>
</li>
<li>
<p>Commit the generated code to Git.</p>
</li>
<li>
<p>In your CI, repeat steps 1 and 2 (using a Docker container for the database).</p>
</li>
<li>
<p>Check for any uncommitted change to the generated code, and if found, fail the build. For example, assuming your
generated code lives in the director <code>generated/</code>, you can call Git like this: <code>git diff --exit-code generated/</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Another approach is to have a CI stage to generate the code as "artifacts", and pass those artifacts on to subsequent CI stages, which can use the generated code in tests, packaging the code, or building Docker images.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generated_code_style_conventions"><a class="anchor" href="#_generated_code_style_conventions"></a>Generated code style conventions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All generated code uses the following style conventions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>File names, interfaces and type aliases use PascalCase</p>
</li>
<li>
<p>Properties, methods, function parameters, and local variables use camelCase</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Generated files contain a special comment to disable eslint.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the rose Antora UI theme.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
